<!DOCTYPE html>
<html>
<head>
    <title>Expense Tracker</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        h1, h2 { margin-top: 20px; }
        form { margin: 20px 0; }
        label { display: block; margin: 10px 0 5px 0; }
        input, select, textarea { width: 300px; padding: 5px; margin-bottom: 10px; }
        button { padding: 8px 15px; margin: 5px; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f0f0f0; }
        .stats { margin: 20px 0; }
    </style>
</head>
<body>
    <h1>Expense Tracker</h1>

    <h2>Add Expense</h2>
    <form id="expenseForm">
        <label>Category:</label>
        <select id="category" required>
            <option value="">Select...</option>
            <option value="Food">Food</option>
            <option value="Transport">Transport</option>
            <option value="Entertainment">Entertainment</option>
            <option value="Utilities">Utilities</option>
            <option value="Rent">Rent</option>
            <option value="Other">Other</option>
        </select>

        <label>Amount:</label>
        <input type="number" id="amount" step="0.01" min="0" required>

        <label>Date:</label>
        <input type="date" id="date" required>

        <label>Description:</label>
        <textarea id="description" rows="2" maxlength="200"></textarea>

        <button type="submit">Add Expense</button>
    </form>
    <div id="message"></div>

    <h2>Statistics</h2>
    <button onclick="loadStats()">Refresh</button>
    <div class="stats" id="stats"></div>

    <h2>All Expenses</h2>
    <button onclick="loadExpenses()">Refresh</button>
    <table id="expensesTable">
        <thead>
            <tr>
                <th>Category</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Description</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="expensesBody"></tbody>
    </table>

    <script>
        const API = '/api';

        document.getElementById('date').valueAsDate = new Date();

        document.getElementById('expenseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const category = document.getElementById('category').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const date = document.getElementById('date').value;
            const description = document.getElementById('description').value.trim() || '';

            if (!category || !amount || !date) {
                document.getElementById('message').textContent = 'Please fill in all required fields';
                return;
            }

            try {
                const response = await fetch(`${API}/expenses`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category, amount, date, description })
                });
                const result = await response.json();
                if (result.success) {
                    document.getElementById('message').textContent = 'Expense added successfully';
                    document.getElementById('expenseForm').reset();
                    document.getElementById('date').valueAsDate = new Date();
                    loadStats();
                    loadExpenses();
                } else {
                    document.getElementById('message').textContent = 'Error: ' + result.message;
                }
            } catch (error) {
                document.getElementById('message').textContent = 'Error: ' + error.message;
                console.error('Error details:', error);
            }
        });

        async function loadStats() {
            try {
                const response = await fetch(`${API}/stats`);
                const data = await response.json();
                document.getElementById('stats').innerHTML = `
                    <p><strong>Total Expense:</strong> $${data.total.toFixed(2)}</p>
                    <p><strong>Highest Category:</strong> ${data.highest.category} ($${data.highest.amount.toFixed(2)})</p>
                    <p><strong>Lowest Category:</strong> ${data.lowest.category} ($${data.lowest.amount.toFixed(2)})</p>
                    <p><strong>By Category:</strong></p>
                    <ul>
                        ${Object.entries(data.byCategory).map(([cat, amt]) => 
                            `<li>${cat}: $${amt.toFixed(2)}</li>`
                        ).join('')}
                    </ul>
                `;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadExpenses() {
            try {
                const response = await fetch(`${API}/expenses`);
                const expenses = await response.json();
                const tbody = document.getElementById('expensesBody');
                tbody.innerHTML = expenses.map(exp => `
                    <tr id="row-${exp.id}">
                        <td>${exp.category}</td>
                        <td>$${exp.amount.toFixed(2)}</td>
                        <td>${exp.date}</td>
                        <td>${exp.description || '-'}</td>
                        <td>
                            <button onclick="editExpense(${exp.id})">Edit</button>
                            <button onclick="deleteExpense(${exp.id})">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading expenses:', error);
            }
        }

        async function editExpense(id) {
            try {
                const response = await fetch(`${API}/expenses/${id}`);
                const exp = await response.json();
                const row = document.getElementById(`row-${id}`);
                row.innerHTML = `
                    <td>
                        <select id="edit-cat-${id}">
                            <option value="Food" ${exp.category === 'Food' ? 'selected' : ''}>Food</option>
                            <option value="Transport" ${exp.category === 'Transport' ? 'selected' : ''}>Transport</option>
                            <option value="Entertainment" ${exp.category === 'Entertainment' ? 'selected' : ''}>Entertainment</option>
                            <option value="Utilities" ${exp.category === 'Utilities' ? 'selected' : ''}>Utilities</option>
                            <option value="Rent" ${exp.category === 'Rent' ? 'selected' : ''}>Rent</option>
                            <option value="Other" ${exp.category === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </td>
                    <td><input type="number" id="edit-amt-${id}" value="${exp.amount}" step="0.01"></td>
                    <td><input type="date" id="edit-date-${id}" value="${exp.date}"></td>
                    <td><input type="text" id="edit-desc-${id}" value="${exp.description || ''}"></td>
                    <td>
                        <button onclick="saveExpense(${id})">Save</button>
                        <button onclick="loadExpenses()">Cancel</button>
                    </td>
                `;
            } catch (error) {
                alert('Error loading expense');
            }
        }

        async function saveExpense(id) {
            const category = document.getElementById(`edit-cat-${id}`).value;
            const amount = parseFloat(document.getElementById(`edit-amt-${id}`).value);
            const date = document.getElementById(`edit-date-${id}`).value;
            const description = document.getElementById(`edit-desc-${id}`).value.trim() || '';

            try {
                const response = await fetch(`${API}/expenses/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category, amount, date, description })
                });
                const result = await response.json();
                if (result.success) {
                    loadStats();
                    loadExpenses();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                alert('Error updating expense');
            }
        }

        async function deleteExpense(id) {
            if (!confirm('Delete this expense?')) return;
            try {
                const response = await fetch(`${API}/expenses/${id}`, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    loadStats();
                    loadExpenses();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                alert('Error deleting expense');
            }
        }

        window.onload = function() {
            loadStats();
            loadExpenses();
        };
    </script>
</body>
</html>
